# Font-Separate 使用说明

## 项目简介

Font-Separate 是一个智能文档颜色分类系统，使用网格聚类算法自动识别和分类文档中的不同颜色文字。

**核心功能**：
- 自动检测文档中的颜色类别
- 区分彩色文字和灰度文字
- 生成每个颜色类别的独立图像
- 提供可视化标注和统计信息

**技术特点**：
- 无需 OCR，直接基于像素颜色分析
- 网格化采样，处理速度快
- 自动聚类，无需预设颜色
- 白色背景过滤，专注文字内容

## 环境要求

- Python 3.10+
- Conda 包管理器

## 安装步骤

### 1. 创建 Conda 环境

```bash
conda create -n font-separate python=3.10 -y
conda activate font-separate
```

### 2. 安装依赖

```bash
pip install -r requirements.txt
```

核心依赖包：
- Flask 3.0 (Web 框架)
- OpenCV 4.6 (图像处理)
- NumPy (数值计算)
- scikit-learn (K-Means 聚类)

## 运行方式

### Web 界面模式（推荐）

1. 启动服务器：
```bash
conda activate font-separate
python app.py
```

2. 访问 http://localhost:5000

3. 上传文档图像，系统会自动：
   - 网格化提取文字颜色
   - 聚类识别颜色类别
   - 生成每个颜色的独立图像
   - 展示可视化标注结果

### 输出结果

每次处理会生成以下文件（保存在 `results/` 目录）：

- `*_color_annotated.jpg` - 颜色分类标注图（彩虹色边框）
- `*_cluster_0.jpg` - 第 0 个颜色类别
- `*_cluster_1.jpg` - 第 1 个颜色类别
- `*_cluster_N.jpg` - 第 N 个颜色类别
- `*_color_stats.json` - 颜色统计数据（JSON 格式）

## 核心算法

### 网格颜色聚类 (ColorClassifier)

**算法流程**：

```
步骤1: 网格化采样
├─ 将图像划分为 20×20 像素的网格
├─ 每个网格计算中位数颜色
└─ 过滤白色背景（RGB ≥ 200）

步骤2: 颜色分类
├─ 区分彩色网格（饱和度 > 25）和灰度网格
├─ 彩色网格：按 Hue（色调）聚类
└─ 灰度网格：按 Value（明度）聚类

步骤3: K-Means 聚类
├─ 自动确定最佳聚类数（2-6 类）
├─ 使用轮廓系数（Silhouette Score）评估
└─ 彩色和灰度分别聚类后合并

步骤4: 生成结果
├─ 为每个类别生成独立图像（白色背景）
├─ 绘制标注图（彩虹色边框）
└─ 输出统计信息（每类的网格数量、颜色信息）
```

**关键参数**：

```python
# utils/color_classifier.py

grid_size = 20              # 网格大小（像素）
white_threshold = 200       # 白色过滤阈值（RGB）
saturation_threshold = 25   # 彩色/灰度分界线（HSV 饱和度）
min_clusters = 2            # 最小聚类数
max_clusters = 6            # 最大聚类数
```

### 颜色空间说明

**RGB → HSV 转换**：
- **Hue (色调)**：0-179，表示颜色类型（红/绿/蓝等）
- **Saturation (饱和度)**：0-255，表示颜色鲜艳程度
- **Value (明度)**：0-255，表示颜色亮度

**分类策略**：
- 饱和度 > 25：彩色文字，使用 Hue 聚类（红/蓝/绿笔区分）
- 饱和度 ≤ 25：灰度文字，使用 Value 聚类（深浅墨迹区分）

## 参数调优

### 调整网格大小

编辑 `utils/color_classifier.py:15`：

```python
self.grid_size = 20  # 默认 20px

# 增大（如 30）→ 处理速度快，但精度降低
# 减小（如 10）→ 精度高，但处理慢
```

### 调整白色过滤阈值

编辑 `utils/color_classifier.py:16`：

```python
self.white_threshold = 200  # 默认 200

# 增大（如 220）→ 过滤更多浅色背景
# 减小（如 180）→ 保留更多浅色文字
```

### 调整饱和度阈值

编辑 `utils/color_classifier.py:17`：

```python
self.saturation_threshold = 25  # 默认 25

# 增大（如 40）→ 更多颜色被归为灰度
# 减小（如 15）→ 更多颜色被归为彩色
```

### 调整聚类数量范围

编辑 `utils/color_classifier.py:123-124`：

```python
min_clusters = 2  # 最少颜色类别
max_clusters = 6  # 最多颜色类别

# 现代文档（多种彩笔）：max_clusters = 8
# 历史文档（单色墨迹）：max_clusters = 3
```

## 项目结构

```
Font-Separate/
├── app.py                       # Flask 主应用（155行）
├── utils/
│   └── color_classifier.py      # 颜色分类器（390行）
├── static/
│   ├── css/style.css            # 前端样式
│   └── js/main.js               # 前端逻辑
├── templates/
│   └── index.html               # Web 界面
├── Pictures/                    # 测试样本
├── uploads/                     # 用户上传临时目录
├── results/                     # 处理结果输出目录
└── docs/
    ├── 使用说明.md              # 本文件
    ├── COLOR_CLASSIFICATION.md  # 颜色分类算法文档
    └── 开发历程文档.md          # 开发过程记录
```

## 适用场景

### ✅ 适用文档

1. **现代彩色文档**
   - 多种彩笔标注（红/蓝/绿笔）
   - 打印签章（红色印章）
   - 彩色批注和修改

2. **历史档案扫描件**
   - 不同时期墨迹（深浅不一）
   - 褪色程度不同的文字
   - 需区分原始内容和后期批注

3. **教育文档**
   - 老师红笔批改
   - 学生答题（黑笔）
   - 彩色标注和重点

### ❌ 不适用场景

1. **严重褪色文档** - 所有文字褪色成同一灰度（无法区分）
2. **单一颜色文档** - 整篇都是黑色或蓝色（没有分类意义）
3. **彩色背景文档** - 背景色干扰（需先预处理）

## 算法性能

**处理速度**（Intel i5 CPU）：
- 1000×800px 图像：约 5-8 秒
- 2000×1600px 图像：约 12-18 秒
- 4000×3200px 图像：约 30-45 秒

**内存占用**：
- 小图（<1MB）：约 200MB
- 中图（1-5MB）：约 500MB
- 大图（>5MB）：约 1GB

**准确度**：
- 现代彩色文档：85-95%（彩色笔区分清晰）
- 历史档案：15-40%（墨迹褪色严重，颜色差异小）

## 常见问题

### Q: 颜色分类不准确？

**A: 根据文档类型调整参数**

1. 如果**彩色笔误判为灰度**：
   - 降低 `saturation_threshold`（如改为 15）

2. 如果**灰度墨迹误判为彩色**：
   - 提高 `saturation_threshold`（如改为 40）

3. 如果**类别太多**：
   - 降低 `max_clusters`（如改为 3）

4. 如果**类别太少**：
   - 提高 `max_clusters`（如改为 8）

### Q: 服务器启动失败？

**A: 检查环境配置**
```bash
# 确认 conda 环境已激活
conda activate font-separate

# 重新安装依赖
pip install -r requirements.txt

# 检查端口占用
lsof -i:5000
```

### Q: 处理速度太慢？

**A: 优化参数**
```python
# 增大网格大小（降低精度换速度）
self.grid_size = 30  # 从 20 改为 30

# 降低最大聚类数
max_clusters = 4  # 从 6 改为 4
```

### Q: 内存占用过高？

**A: 添加图像缩放**

编辑 `utils/color_classifier.py:53-58`：

```python
def classify_by_color(self, image_path, output_dir):
    img = cv2.imread(image_path)
    h, w = img.shape[:2]

    # 添加图像缩放
    max_size = 2000
    if max(h, w) > max_size:
        scale = max_size / max(h, w)
        img = cv2.resize(img, None, fx=scale, fy=scale)
```

### Q: 历史文档效果很差？

**A: 历史文档颜色分类的局限性**

历史档案由于墨迹严重褪色，所有文字退化成相似的灰色，导致颜色分类效果很差（准确度仅 15-40%）。

**替代方案**：
1. 使用专业的历史文档处理工具
2. 采用深度学习模型（需标注训练数据）
3. 人工标注后批量处理

## 技术文档

详细技术说明请参考：

- `COLOR_CLASSIFICATION.md` - 颜色分类算法完整文档
- `开发历程文档.md` - 项目开发过程和决策记录

## 作者与许可

- 基于 OpenCV 和 Flask 构建
- 适用于文档数字化、档案管理、教育批改等场景
- 测试图像为历史档案扫描件样本
