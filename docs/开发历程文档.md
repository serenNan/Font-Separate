# Font-Separate 项目开发历程

**项目名称**：Font-Separate - 文档图像智能分离系统
**开发周期**：2025年9月30日 - 2025年10月8日（9天）
**提交次数**：15次
**最终状态**：单一颜色分类系统

---

## 一、项目背景与需求

### 初始需求

从历史文档扫描件中自动分离：
1. 表格区域
2. 手写体文字
3. 印刷体文字
4. 不同颜色的文字

### 测试样本特点

样本为历史档案扫描件（Pictures/原始.jpg）：
- 左侧：印刷表格（多行多列）
- 右侧：手写批注（毛笔字）
- 纸张老化，有污渍和破损
- 墨迹严重褪色，对比度低
- 表格线模糊且有断裂

---

## 二、开发时间线

### 第一阶段：基础架构（2025-09-30）

**提交 350b5e4 - init**
- 创建项目目录
- 添加测试图片 Pictures/1.jpg, 2.jpg, 3.jpg
- 创建需求文档

**提交 d387ece - 基础架构等**
- 搭建完整 Flask Web 应用框架
- 实现表格检测器 utils/table_detector.py (448行)
- 创建前端界面 (HTML/CSS/JS)
- 添加 CLAUDE.md 项目指南
- 新增文件：app.py (122行), static/, templates/, uploads/, results/

表格检测算法流程：
```
灰度化 → Otsu二值化 → 形态学分离横竖线 → Hough变换检测直线 →
线条合并 → 交叉点聚类 → 定位表格区域
```

---

### 第二阶段：文字分类探索（2025-10-02）

**提交 17bdfad - 完成区分但是效果很差**
- 实现基于形态学特征的文字分类器 (332行)
- 使用骨架化和距离变换提取笔画宽度特征
- 分析圆形度和像素密度
- 新增 utils/text_classifier.py
- 新增 test_classifier.py 测试工具
- 新增使用说明文档

算法特征：
- 笔画宽度变异系数：手写体笔画粗细变化大
- 圆形度：手写体形状不规则
- 像素密度：手写体墨迹浓度不均

效果：准确度约 30%，特征受图像质量影响极大

**提交 d075836 - 图片预处理**
- 尝试通过增强预处理改善效果
- 新增 preprocess_text.py (54行)
- 新增 utils/text_extractor.py (294行)
- 预处理流程：双边滤波 → 锐化 → CLAHE → 自适应阈值

效果：准确度提升到约 40%，仍不理想

---

### 第三阶段：算法转向（2025-10-03）

**提交 82dc3ae - 进一步去噪**
- 创建5个实验性脚本探索不同方案
- advanced_denoise.py (238行) - 连通组件分析去噪
- classify_preprocessed.py (176行)
- classify_yolo.py (117行) - YOLO方案
- detect_text_craft.py (107行) - CRAFT检测
- detect_text_paddleocr.py (105行) - PaddleOCR方案

结论：深度学习方案需要训练数据，传统方法无法准确区分

**提交 9e0286e - 进一步区分，效果60分吧**
- 放弃形态学特征，改用 EasyOCR
- 删除所有实验脚本
- 重写 text_classifier.py：从 321行简化到 93行（减少 72%）
- 新增 classify_easyocr.py (161行) 独立测试工具
- 新增 DEPLOYMENT.md 部署文档

新算法思路：
```python
# 使用 EasyOCR 检测文字
reader = easyocr.Reader(['ch_sim', 'en'], gpu=False)
results = reader.readtext(image_path)

# 基于位置分类（利用文档布局）
split_x = w * 0.45  # 45%分界线
if center_x < split_x:
    → 印刷体（左侧表格）
else:
    → 手写体（右侧批注）
```

效果：准确度提升到约 60%，依赖固定布局

---

### 第四阶段：表格检测突破（2025-10-04）

**提交 31ad7c5 - 表格分离完善**
- 引入内容密度分析（重大突破）
- utils/table_detector.py 从 448行扩展到 471行
- 新增 test_classifier.py (76行) 综合测试工具
- 更新 CLAUDE.md 和截图文档

核心创新：
```python
def calculate_content_density(region_img, binary_img):
    # 计算黑色像素密度
    density = black_pixels / total_area

    # 统计连通组件数量
    num_labels = cv2.connectedComponentsWithStats(binary_img)

    return density, component_count

def classify_table_type(density, component_count, h_lines, v_lines):
    # 空白表格：密度很低，组件很少
    if density < 0.01 and component_count < 3:
        return 'empty_table'

    # 标题框：密度很高或线条很少
    if density > 0.20 and component_count < 30:
        return 'title_box'

    # 数据表格
    return 'data_table'
```

效果：表格分离准确度从 50% 提升到 85%，首个成功功能

**提交 324d837 - 表格进一步完善**
- 微调内容密度阈值
- 优化表格分类规则

**提交 c7f949f - 网站部分完善**
- 删除旧测试代码
- 优化前端展示逻辑

---

### 第五阶段：颜色分类尝试（2025-10-04 晚）

**提交 f33d67f - 颜色区分，效果较好**
- 新增颜色分类功能
- 新增 utils/color_classifier.py (390行)
- 新增 test_scripts/color_classify_demo.py (159行)
- 新增 COLOR_CLASSIFICATION.md 详细文档
- 更新 CLAUDE.md

算法设计：
```python
# 1. EasyOCR 检测文字区域
results = reader.readtext(image_path)

# 2. 提取文字颜色（使用Otsu二值化）
_, mask = cv2.threshold(gray, 0, 255, cv2.THRESH_BINARY_INV + cv2.THRESH_OTSU)
text_pixels = roi[mask > 0]
median_color = np.median(text_pixels, axis=0)

# 3. 转换到Lab色彩空间
color_lab = cv2.cvtColor(color_bgr, cv2.COLOR_BGR2Lab)

# 4. K-Means聚类（自动确定k值）
kmeans = KMeans(n_clusters=k)
labels = kmeans.fit_predict(colors)
```

特点：
- 完全自适应，不预设固定颜色
- 使用轮廓系数自动确定聚类数（2-6类）
- Lab色彩空间更符合人类感知

---

### 第六阶段：Web界面集成（2025-10-05）

**提交 fadea8e - 添加功能选择**
- Web界面集成三种处理模式
- app.py 从 122行扩展到 154行
- 更新前端界面支持方法选择
- 移动 color_classify_demo.py 到 test_scripts/
- 新增测试样本 Pictures/原始2.jpg

三种模式：
1. 表格分离（/process_table）
2. 手写/印刷体分类（/process_text）
3. 颜色分类（/process_color）

**提交 ba2c3c5 - 完善网站加载图片逻辑**
- 优化前端图片加载和展示
- 添加文件名时间戳（防止缓存问题）
- 改进错误处理
- 删除临时截图文件

---

### 第七阶段：颜色算法深入研究（2025-10-05 晚）

**提交 6bcfca0 - 新增颜色分类功能和RGB像素级检测**
- 大幅更新 CLAUDE.md (548行)
- 新增4个颜色分析测试脚本：
  - test_scripts/color_hue_classify.py (223行) - 色调分类
  - test_scripts/color_hue_range_classify.py (180行) - 色调范围分类
  - test_scripts/color_target_classify.py (199行) - 目标颜色检测
  - test_scripts/inspect_raw_colors.py (186行) - 原始颜色分析
- 优化 utils/color_classifier.py

深入分析发现：
- 历史文档墨迹严重褪色
- 所有颜色退化成灰色（饱和度 < 30）
- 聚类结果为3种极其相近的灰色调
- Otsu二值化对褪色文档失效

---

### 第八阶段：颜色算法重构（2025-10-08）

**提交 edcb244 - 完善颜色分类算法，效果良好**
- 完全重写 utils/color_classifier.py (519行)
- 新增 test_scripts/color_cluster.py (258行)
- 新增改进版 test_scripts/color_hue_range_classify.py (87行)
- 创建开发历程文档.md (617行)

重大改进：网格化颜色聚类算法
```python
# 1. 网格化采样（20×20像素）
grid_size = 20
for y in range(0, h, grid_size):
    for x in range(0, w, grid_size):
        grid = img[y:y+grid_size, x:x+grid_size]
        median_color = np.median(grid.reshape(-1, 3), axis=0)

# 2. 过滤白色背景
if np.all(median_color >= 200):
    continue

# 3. 颜色分类（彩色/灰度）
hsv = cv2.cvtColor(color_bgr, cv2.COLOR_BGR2HSV)
if hsv[1] > 25:  # 饱和度 > 25
    colored_grids.append(hsv[0])  # 使用Hue
else:
    grayscale_grids.append(hsv[2])  # 使用Value

# 4. 分别聚类后合并
colored_clusters = kmeans.fit_predict(colored_grids)
grayscale_clusters = kmeans.fit_predict(grayscale_grids)
```

核心优势：
- 无需OCR，直接基于像素颜色分析
- 网格化采样，处理速度快
- 彩色/灰度分类，更准确
- 自动聚类，无需预设颜色

**提交 80d0f70 - 去除表格分离，书写颜色分类改进**
- 简化 app.py：移除表格分离逻辑
- 更新前端界面：移除方法选择
- 新增颜色分类改进记录.md (640行)
- 在 utils/table_detector.py 添加废弃说明

项目重新定位：专注于颜色分类单一功能

---

## 三、最终成果与功能状态

### 已移除功能

#### 1. 表格分离（已移除，代码保留）
- 准确度：85%
- 状态：从主应用移除（2025-10-08）
- 原因：项目重新定位为颜色分类系统
- 代码位置：utils/table_detector.py（已标记废弃）

核心算法：
- Hough变换检测线条
- 内容密度分析过滤空白表格
- 垂直线间隙分割多表格

#### 2. 手写/印刷体分类（已移除）
- 准确度：60%
- 状态：从主应用移除（2025-10-08）
- 原因：准确度不足，强依赖固定布局
- 代码位置：utils/text_classifier.py（已废弃）

算法演变：
- 尝试1：形态学特征（30%准确度）→ 失败
- 尝试2：增强预处理（40%准确度）→ 失败
- 尝试3：EasyOCR + 位置分类（60%准确度）→ 不满意

### 当前功能

#### 颜色分类（唯一保留功能）
- 算法：网格化颜色聚类
- 适用场景：现代彩色文档，多种笔迹颜色区分
- 不适用场景：历史文档（墨迹褪色成灰色）

技术特点：
- 20×20像素网格采样
- 白色背景过滤（RGB ≥ 200）
- 彩色/灰度分类（饱和度阈值25）
- K-Means自动聚类（2-6类）
- 轮廓系数评估最佳聚类数

处理流程：
```
网格化采样 → 过滤背景 → 提取中位数颜色 →
RGB转HSV → 彩色/灰度分类 → 分别聚类 →
合并结果 → 生成独立图像
```

---

## 四、颜色分类算法详解

### 核心创新

**问题**：基于OCR的颜色分类对历史文档失效
- Otsu二值化假设双峰分布
- 褪色文档墨迹和背景都是灰色
- 分割不准确，混入大量背景像素

**解决方案**：网格化采样
- 不依赖OCR文字检测
- 直接在整个图像上均匀采样
- 使用中位数抗离群点干扰

### 算法参数

```python
# utils/color_classifier.py
grid_size = 20              # 网格大小（像素）
white_threshold = 200       # 白色过滤阈值（RGB）
saturation_threshold = 25   # 彩色/灰度分界线（HSV饱和度）
min_clusters = 2            # 最小聚类数
max_clusters = 6            # 最大聚类数
```

### 颜色空间策略

**HSV色彩空间**：
- **Hue（色调）**：0-179，表示颜色类型
- **Saturation（饱和度）**：0-255，表示鲜艳程度
- **Value（明度）**：0-255，表示亮度

**分类策略**：
- 饱和度 > 25 → 彩色文字，使用 Hue 聚类（红/蓝/绿笔区分）
- 饱和度 ≤ 25 → 灰度文字，使用 Value 聚类（深浅墨迹区分）

### 聚类优化

**自动确定K值**：
```python
best_k = 2
best_score = -1

for k in range(min_clusters, max_clusters + 1):
    kmeans = KMeans(n_clusters=k, random_state=42)
    labels = kmeans.fit_predict(features)
    score = silhouette_score(features, labels)

    if score > best_score:
        best_score = score
        best_k = k
```

使用轮廓系数（Silhouette Score）评估：
- 范围：-1 到 1
- 值越大，聚类效果越好
- 自动选择最佳聚类数

---

## 五、失败经验与教训

### 历史文档的颜色区分

**墨迹褪色问题**：
- 原始黑色墨水 → 深灰色（RGB 120）
- 原始蓝色墨水 → 中灰色（RGB 160-180）
- 原始红色印章 → 褐灰色（RGB 170-190）
- 最深墨迹亮度都 > 90（远离纯黑0）

**传统方法失效**：
- Otsu二值化：假设双峰分布，对褪色文档不适用
- 形态学特征：受图像质量影响极大
- 基于规则的方法：对退化严重的图像失效

### 算法演变总结

**手写/印刷体分类**：
- 形态学特征 → 30%准确度
- 增强预处理 → 40%准确度
- EasyOCR + 位置分类 → 60%准确度
- 结论：传统方法达到天花板，需要深度学习

**颜色分类**：
- OCR + 颜色聚类 → 15%准确度（褪色成灰色）
- OCR + 亮度聚类 → 40%准确度（界限模糊）
- OCR + 墨迹深度 → 50%准确度（漏检70%）
- 网格化颜色聚类 → 适用于现代文档
- 结论：历史文档墨迹褪色，颜色分类无意义

---

## 六、代码统计

### 最终代码规模

| 模块 | 文件 | 行数 | 状态 |
|------|------|------|------|
| 颜色分类 | utils/color_classifier.py | 390 | ✅ 使用中 |
| 表格检测 | utils/table_detector.py | 471 | ⚠️ 已废弃 |
| 文字分类 | utils/text_classifier.py | 143 | ⚠️ 已废弃 |
| 文字提取 | utils/text_extractor.py | 294 | ⚠️ 保留 |
| Web后端 | app.py | 155 | ✅ 使用中 |
| 前端 | static/ + templates/ | ~500 | ✅ 使用中 |
| 测试工具 | test_scripts/ | ~1200 | 📝 实验代码 |
| 文档 | docs/ + *.md | ~2500 | 📄 文档 |
| 总计 | | ~5653 | |

### 提交统计

总提交次数：15次（2025-09-30 到 2025-10-08）
- 成功功能：1个（颜色分类）
- 废弃功能：2个（表格分离、文字分类）
- 失败尝试：6次
  - 形态学特征分类
  - 图像增强 + 形态学
  - YOLO/CRAFT/PaddleOCR方案
  - EasyOCR + 位置分类（勉强）
  - OCR + 颜色聚类
  - OCR + 亮度/墨迹深度

---

## 七、改进方向

### 当前功能优化

**颜色分类改进**：
1. 支持更多颜色空间（Lab、HSV、RGB）
2. 优化网格大小（自适应根据图像尺寸）
3. 改进白色背景过滤策略
4. 优化聚类参数（距离度量、初始化方法）

### 历史文档处理建议

对于严重褪色的历史文档：
1. 使用专业的历史文档处理工具
2. 采用深度学习模型（需要200-500张标注样本）
3. 自动分类 + 人工审核（行业标准）
4. 完全自动化不现实

---

## 八、项目总结

### 成功之处

1. **网格化颜色聚类算法**
   - 无需OCR，直接基于像素分析
   - 适用于现代彩色文档
   - 算法简洁高效

2. **详细的技术文档**
   - 记录完整的开发历程
   - 分析失败原因和教训
   - 为后续改进提供参考

### 遇到的挑战

1. **历史文档的特殊性**
   - 墨迹严重褪色
   - 传统图像处理方法失效
   - 需要专门的算法或深度学习

2. **技术选型的困难**
   - 形态学特征不稳定
   - 深度学习需要训练数据
   - 最终采用启发式方法

3. **功能定位的调整**
   - 从多功能系统
   - 收缩为单一颜色分类系统
   - 更加专注和实用

### 经验与启示

1. **充分的可行性分析很重要**
   - 应该先做小规模测试
   - 评估技术方案的可行性
   - 避免在错误方向上浪费时间

2. **简单方案不一定有效，但值得尝试**
   - 位置分类比形态学特征简单得多
   - 但效果更好（从30%到60%）
   - 最终仍不足以满足需求

3. **了解问题域比优化算法更重要**
   - 历史文档的特殊性决定了传统方法的局限
   - 应该根据具体问题选择合适的技术
   - 必要时调整项目目标和范围

---
