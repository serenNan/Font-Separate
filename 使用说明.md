# Font-Separate 使用说明

## 项目简介

Font-Separate 是一个智能文档图像分离系统,可以从历史文档扫描件中自动分离:
1. **表格区域** - 基于 Hough 变换检测表格线
2. **手写体文字** - 基于形态学特征识别手写体
3. **印刷体文字** - 识别规整的印刷文字

## 环境要求

- Python 3.10
- Conda 包管理器

## 安装步骤

### 1. 创建 Conda 环境

```bash
conda create -n font-separate python=3.10 -y
conda activate font-separate
```

### 2. 安装依赖

```bash
pip install -r requirements.txt
```

依赖包包括:
- Flask 3.0 (Web 框架)
- OpenCV 4.6 + opencv-contrib (图像处理)
- PaddlePaddle + PaddleOCR (OCR 引擎,已安装但未集成)
- scikit-learn, scipy (机器学习库)
- 其他辅助库

## 运行方式

### Web 界面模式(推荐)

1. 启动服务器:
```bash
conda activate font-separate
python app.py
```

2. 访问 http://localhost:5000

3. 上传文档图像,系统会自动:
   - 检测并分离表格
   - 分类手写体和印刷体
   - 展示标注结果

### 命令行测试模式

测试手写体分类器:
```bash
conda activate font-separate
python test_classifier.py Pictures/1.jpg
```

输出示例:
```
检测到 124 个文字区域
分类结果: 手写体=121, 印刷体=3
输出文件:
  手写体: results/1_handwritten.jpg
  印刷体: results/1_printed.jpg
  标注图: results/1_text_annotated.jpg
```

## 核心算法

### 表格检测 (TableDetector)

1. **预处理**: 灰度化 → Otsu 二值化
2. **线条检测**: 形态学操作 + Hough 变换
3. **线条合并**: 合并相近的平行线(阈值 15px)
4. **区域识别**: 交叉点聚类 + 垂直线间隙分割(阈值 100px)
5. **内容过滤**:
   - 空白表格过滤(密度 < 0.01)
   - 标题框过滤(密度 > 0.15 或横线 ≤ 2)

关键参数(table_detector.py):
- 形态学核: 水平(40,1), 垂直(1,40)
- Hough: 阈值100, 最小线长100px, 最大间隙10px

### 手写体/印刷体分类 (TextClassifier)

基于形态学特征的分类:

1. **特征提取**:
   - **笔画宽度变异系数** (Stroke Width CV): 手写体笔画粗细变化大
   - **圆形度** (Circularity): 印刷体形状规整,手写体不规则
   - **像素密度** (Density): 墨迹浓度

2. **分类规则**:
   ```python
   手写体特征:
   - stroke_cv > 0.35        (笔画变化大)
   - circularity < 0.3       (形状不规则)
   - 综合评分 ≥ 2

   印刷体特征:
   - stroke_cv < 0.25        (笔画均匀)
   - circularity > 0.5       (形状规整)
   ```

3. **骨架化分析**: 使用 `cv2.ximgproc.thinning()` 提取笔画骨架

## 输出结果

每次处理会生成以下文件(保存在 `results/` 目录):

### 表格分离结果
- `*_table.jpg` - 表格内容
- `*_non_table.jpg` - 非表格内容
- `*_table_annotated.jpg` - 表格标注(绿色框)
- `*_lines.jpg` - 线条检测(红色垂直线,蓝色水平线)

### 文字分类结果
- `*_handwritten.jpg` - 手写体内容
- `*_printed.jpg` - 印刷体内容
- `*_text_annotated.jpg` - 文字分类标注(红色=手写,蓝色=印刷)

## 参数调优

### 表格检测不准确

编辑 `utils/table_detector.py`:

```python
# 调整 Hough 变换阈值(第51, 63行)
threshold=100  # 降低阈值可检测更多线条

# 调整形态学核大小(第45, 57行)
(40, 1)  # 增大可检测更粗的线条

# 调整表格分割阈值(第234行)
gap > 100  # 增大可避免误分割
```

### 手写体误判

编辑 `utils/text_classifier.py`:

```python
# 调整分类阈值(第148-161行)
stroke_cv > 0.35   # 降低阈值可识别更多手写体
circularity < 0.3  # 提高阈值可减少误判
handwritten_score >= 2  # 提高分数阈值可减少误判
```

### 文字区域过滤

编辑 `utils/text_classifier.py`:

```python
# 调整最小区域面积(第61行)
min_area = 200  # 增大可过滤更多噪点
```

## 项目结构

```
Font-Separate/
├── app.py                    # Flask 主应用
├── utils/
│   ├── table_detector.py     # 表格检测器
│   └── text_classifier.py    # 手写体分类器
├── static/
│   ├── css/style.css         # 前端样式
│   └── js/main.js            # 前端逻辑
├── templates/
│   └── index.html            # Web 界面
├── test_classifier.py        # 命令行测试脚本
├── Pictures/                 # 测试样本(历史文档)
├── uploads/                  # 用户上传临时目录
└── results/                  # 处理结果输出目录
```

## 技术特点

1. **无需深度学习模型** - 纯 OpenCV 传统算法,快速轻量
2. **鲁棒的表格检测** - 内容密度过滤避免误检空白表格
3. **形态学特征分类** - 笔画宽度变异系数准确区分手写/印刷
4. **可视化标注** - 所有结果都提供彩色标注图便于验证

## 已知限制

1. **手写体分类准确度** - 基于规则的方法,对某些字体可能误判
2. **表格倾斜** - 当前未实现倾斜校正,倾斜文档需预处理
3. **复杂表格** - 嵌套表格、斜线表头等复杂情况支持有限
4. **OCR未集成** - PaddleOCR 已安装但未集成到流程中

## 下一步开发建议

1. **集成 OCR** - 对分离后的文字进行识别
2. **倾斜校正** - 添加 Hough 变换倾斜检测
3. **表格结构化** - 提取单元格内容为 CSV/JSON
4. **深度学习分类** - 训练轻量级 CNN 提高手写体识别准确度
5. **批量处理** - 支持多文件批量上传处理

## 常见问题

**Q: 服务器启动失败?**
A: 确保已激活 conda 环境并安装所有依赖

**Q: 手写体检测不准确?**
A: 调整 `text_classifier.py` 中的阈值参数

**Q: 表格检测遗漏?**
A: 降低 Hough 变换阈值,或调整形态学核大小

**Q: 内存占用过高?**
A: 在 `preprocess()` 中添加图像缩放逻辑

## 作者与许可

- 基于 OpenCV 和 Flask 构建
- 适用于历史文档数字化、档案管理等场景
- 测试图像为历史档案扫描件样本
